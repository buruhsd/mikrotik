<?php

namespace App\Http\Controllers\Api;

use Illuminate\Http\Request;
use RouterOS\RouterosAPI as Router;
use App\Database\Devices;
use App\Http\Controllers\Controller;

class MikrotikAPI extends Controller
{
  public function login( $id )
  {
    $devices = Devices::join('usermikrotik', 'devices.usermikrotik', '=', 'usermikrotik.id')
    ->where('device_id', $id)->first();
    $routeros = new Router;
    $routeros->debug = false;
    $routeros->port = $devices->port;
    if( $routeros->connect( $devices->device_ip, $devices->username_mikrotik, $devices->password_mikrotik ) )
    {
      $res = [
        'ip' => $devices->device_ip,
        'status' => 200,
        'response' => 'Connected',
        'command' => new $routeros
      ];
    }
    else
    {
      $res = [
        'ip' => $devices->device_ip,
        'status' => 200,
        'response' => 'Not connected'
      ];
    }
    return $res;
  }

  public function showlog( $id )
  {
    $login = $this->login( $id );
    if( $login['response'] == 'Connected' )
    {
      $res = [
        'result' => $login['command']->comm('/log/print'),
        'status' => 'connected'
      ];
      $login['command']->disconnect();
    }
    else
    {
      $res = [
        'result' => null,
        'status' => 'disconnected'
      ];
    }

    return response()->json( $res );
  }
}
